(function(){function d(){for(var a=this.curLine+1,b=this.code.beforeFuncs[this.curLine],c=this.code.funcs[this.curLine],e=this.code.afterFuncs[this.curLine],d;c;){b&&b(this);var f=c(this);e&&e(this);"undefined"!==typeof f?(d=!1,a=f):(d=!0,f=a,a++);b=this.code.beforeFuncs[f];c=this.code.funcs[f];e=this.code.afterFuncs[f];if(!c||!c.isSkip){d&&a--;break}}this.setCurrentLine(a);this.isRunning&&this.curLine>=this.code.funcs.length&&this.notifyComplete()}function n(){if(!this.isRunning){var a=this;this.isRunning=
!0;this.runTimerId=setInterval(function(){a.step()},1E3/this.runClock);this.runBtn&&(this.runBtn.value="pause")}}function q(){this.isRunning&&(this.isRunning=!1,clearInterval(this.runTimerId),this.runBtn&&(this.runBtn.value="run"))}function p(){this.code.reset();this.showConsole&&(this.consoleText=this.console.innerHTML="");this.setCurrentLine(this.startLine);this.vars={};this.varsList=[];r(this);this.setup()}function m(){this.frames.push({retLineNo:this.curLine+1,vars:this.vars,varsList:this.varsList});
this.vars={};this.varsList=[];r(this,!0)}function b(a){var b=this.frames.pop();this.ret=a;this.vars=b.vars;this.varsList=b.varsList;r(this,!0);return b.retLineNo}function c(a,b){a in this.vars?this.vars[a]=b:(this.varsList.push(a),this.vars[a]=b,this.notifyCreateVar(a,b));this.notifyChangeVar(a,b)}function e(a,b){this.showConsole&&(a=g(a,!0),b&&(a+="\n"),this.consoleText+=a,this.console.innerHTML=this.consoleText,this.console.scrollTop=this.console.scrollHeight)}function f(a,b,c){a.varsList.length<=
a.maxVarsNum&&(a=a.varsTable.getElementsByClassName("exr-vars-"+(a.varsList.length-1))[0],a.childNodes[0].innerHTML=b,a.childNodes[1].innerHTML=g(c))}function l(a,b,c){if(b in a.vars){var e;a:{e=a.varsList;for(var d=0;d<e.length;d++)if(e[d]===b){e=d;break a}e=-1}-1!==e&&e<=a.maxVarsNum&&(a=a.varsTable.getElementsByClassName("exr-vars-"+e)[0],a.childNodes[0].innerHTML=b,a.childNodes[1].innerHTML=g(c))}}function g(a,b){if("string"===typeof a)b||(a=['"',a,'"'].join(""));else if("[object Array]"===Object.prototype.toString.call(a))a=
["[",a,"]"].join("");else if("object"===typeof a){var c=["{"],e=!0,d;for(d in a)e?e=!1:c.push(", "),c.push(d),c.push(": "),c.push(g(a[d],b));c.push("}");a=c.join("")}else a=""+a;b||(a=a.replace("\n","\\n"));return a}function t(a){this.onChangeVarListeners.push(a)}function u(a,b){var c=this;this.onCreateVarListeners.forEach(function(e){e(c,a,b)})}function v(a,b){var c=this;this.onChangeVarListeners.forEach(function(e){e(c,a,b)})}function w(){var a=this;this.onCompleteListeners.forEach(function(b){b(a)})}
function r(a,b){if(a.showVarsTable)for(var c=0;c<a.maxVarsNum;c++){var e=a.varsTable.getElementsByClassName("exr-vars-"+c)[0];if(b&&c<a.varsList.length){var d=a.varsList[c],f=g(a.vars[d]);e.childNodes[0].innerHTML=d;e.childNodes[1].innerHTML=f}else e.childNodes[0].innerHTML="\u3000",e.childNodes[1].innerHTML="\u3000"}}function x(a){var b=this.example.getElementsByClassName("exr-line-"+this.curLine);1===b.length&&(b[0].style.backgroundColor="");this.curLine=a;b=this.example.getElementsByClassName("exr-line-"+
this.curLine);1===b.length&&(b[0].style.backgroundColor=this.curLineColor)}function y(a){var b=a.innerHTML.split("\n"),c;c="undefined"===typeof a.innerText?a.textContent.split("\n"):a.innerText.split("\n");var e=[];c.forEach(function(a,c){var d="";80>a.length&&(d=Array(80-a.length+1).join(" "));e.push(["<span class='exr-line-",c,"'>",b[c],d,"</span>"].join(""))});a.innerHTML=e.join("\n");return c.length}function z(a){var b=document.createElement("div");b.className="exr-panel";b.innerHTML="<input class='step-button' type='button' value='step' />"+
(a.showRunButton?"<input class='run-button' type='button' value='run' />":"")+"<input class='reset-button' type='button' value='reset' />";a.container.appendChild(b);a.container.insertBefore(b,a.container.firstChild);b.getElementsByClassName("step-button")[0].onclick=function(){a.step()};a.showRunButton&&(a.runBtn=b.getElementsByClassName("run-button")[0],a.runBtn.onclick=function(){a.isRunning?a.pause():a.run()},a.onCompleteListeners.push(function(){a.pause()}));b.getElementsByClassName("reset-button")[0].onclick=
function(){a.reset()}}window.exr={create:function(a){var h=A,k;for(k in h)k in a||(a[k]=h[k]);a.isRunning=!1;a.setCurrentLine=x;a.consoleText="";a.vars={};a.varsList=[];a.step=d;a.run=n;a.pause=q;a.reset=p;a.aCall=m;a.aReturn=b;a.assign=c;a.print=e;a.onCreateVarListeners=[];a.onChangeVarListeners=[];a.onCompleteListeners=[];a.addChangeVarListener=t;a.notifyCreateVar=u;a.notifyChangeVar=v;a.notifyComplete=w;a.numLines=y(a.example);z(a);if(a.showVarsTable){h=[];h.push("<tr><th>Name</th><th>Value</th></tr>");
for(k=0;k<a.maxVarsNum;k++)h.push("<tr class='exr-vars-"),h.push(k),h.push("'><td>\u3000</td><td>\u3000</td></tr>");k=document.createElement("div");k.className="exr-panel";var g=document.createElement("table");g.className="exr-table";g.innerHTML=h.join("");k.appendChild(g);a.container.appendChild(k);a.varsTable=g;a.onCreateVarListeners.push(f);a.onChangeVarListeners.push(l)}a.showConsole&&(h=document.createElement("div"),h.className="exr-panel",h.innerHTML=["<textarea class='exr-console' readonly cols='",
a.consoleCols,"' rows='",a.consoleRows,"'></textarea>"].join(""),a.console=h.getElementsByClassName("exr-console")[0],a.container.appendChild(h));a.setup();a.setCurrentLine(a.startLine)}};var A={container:null,example:null,startLine:0,setup:function(){},code:null,frames:[],maxVarsNum:5,showConsole:!0,consoleCols:80,consoleRows:8,showVarsTable:!0,showRunButton:!1,runClock:10,curLineColor:"#DDF"}})();(function(){function d(){this.funcs=[];this.beforeFuncs=[];this.afterFuncs=[];this.forStack=[];this.whileStack=[];this.foreachStack=[];this.ifStack=[]}function n(){}function q(){}function p(){var b=arguments;return function(c){for(var e=0;e<b.length;e++){var d=b[e](c);if(d)return d}}}function m(b){return function(c,e){this.assign(c,function(d){return b(d.vars[c],e)});return this}}exr.Code=d;n.isSkip=!0;d.prototype.check=function(){if(0!==this.forStack.length)throw"forStack.length = "+this.forStack.length;
if(0!==this.whileStack.length)throw"whileStack.length = "+this.whileStack.length;if(0!==this.foreachStack.length)throw"foreachStack.length = "+this.foreachStack.length;if(0!==this.ifStack.length)throw"ifStack.length = "+this.ifStack.length;};d.prototype.reset=function(){this.funcs.forEach(function(b){b.reset&&b.reset()})};d.prototype.getCurIndex=function(){return this.funcs.length-1};d.prototype.before=function(b){this.beforeFuncs[this.funcs.length]=b;return this};d.prototype.after=function(b){var c=
this.funcs.length-1;if(-1===c)throw"after -1";this.afterFuncs[c]=b;return this};d.prototype.a=function(b){this.funcs.push(b);return this};d.prototype.skip=function(b){for(var c=0;c<b;c++)this.funcs.push(n);return this};d.prototype.print=function(b,c){this.funcs.push(function(e){var d;d="function"===typeof b?b(e):b;e.print(d,c)});return this};d.prototype.println=function(b){this.print(b,!0);return this};d.prototype.printVar=function(b,c){this.print(function(c){return c.vars[b]},c);return this};d.prototype.printVarln=
function(b){this.printVar(b,!0);return this};d.prototype.assign=function(b,c){this.funcs.push(function(e){"function"===typeof c?e.assign(b,c(e)):e.assign(b,c)});return this};d.prototype.add=m(function(b,c){return b+c});d.prototype.sub=m(function(b,c){return b-c});d.prototype.mul=m(function(b,c){return b*c});d.prototype.div=m(function(b,c){return b/c});d.prototype.stop=function(){this.funcs.push(function(b){b.pause();return b.curLine});return this};d.prototype.aCall=function(b,c){this.funcs.push(function(e){"function"===
typeof c&&(e.args=c(e));e.aCall();return b});return this};d.prototype.implicitReturn=function(b){var c=function(c){var d;"function"===typeof b&&(d=b(c));return c.aReturn(d)};c.isSkip=!0;this.funcs.push(c);return this};d.prototype.aReturn=function(b){this.funcs.push(function(c){var e;"function"===typeof b&&(e=b(c));return c.aReturn(e)});return this};d.prototype.aFor=function(b){function c(){if(e>=b)return e=0,d.endI;e++}var e=0,d={};c.reset=function(){e=0};this.funcs.push(c);var l=this.getCurIndex();
this.forStack.push({i:l,obj:d});return this};d.prototype.endFor=function(){var b=this.forStack.pop(),c=function(){return b.i};c.isSkip=!0;this.funcs.push(c);b.obj.endI=this.getCurIndex()+1;return this};d.prototype.breakFor=function(){var b=this.forStack[this.forStack.length-1];this.funcs.push(function(){b.reset();return b.obj.endI});return this};d.prototype.aWhile=function(b){var c={};this.funcs.push(function(d){if(!b(d))return c.endI});var d=this.getCurIndex();this.whileStack.push({i:d,obj:c});return this};
d.prototype.endWhile=function(){var b=this.whileStack.pop(),c=function(){return b.i};c.isSkip=!0;this.funcs.push(c);b.obj.endI=this.getCurIndex()+1;return this};d.prototype.breakWhile=function(){var b=this.whileStack[this.whileStack.length-1];this.funcs.push(function(){return b.obj.endI});return this};d.prototype.foreach=function(b,c){function d(e){"function"===typeof c&&(g=c,c=c(e));if(f>=c.length)return f=0,c=g,l.endI;e.assign(b,c[f]);f++}var f=0,l={},g=c;d.reset=function(){f=0;c=g};this.funcs.push(d);
var m=this.getCurIndex();this.foreachStack.push({i:m,obj:l,reset:d.reset});return this};d.prototype.endForeach=function(){var b=this.foreachStack.pop(),c=function(){return b.i};c.isSkip=!0;this.funcs.push(c);b.obj.endI=this.getCurIndex()+1;return this};d.prototype.breakForeach=function(){var b=this.foreachStack[this.foreachStack.length-1];this.funcs.push(function(){b.reset();return b.obj.endI});return this};d.prototype.aIf=function(b){var c={};this.funcs.push(function(d){if(!b(d))return c.elseI});
this.ifStack.push({type:"if",obj:c,chain:[]});return this};d.prototype.elif=function(b){var c={},d=this.ifStack.pop(),f=d.chain.concat([c]),l=this.getCurIndex();d.obj.elseI=l+1;this.funcs.push(function(d){if(!b(d))return c.elseI});this.ifStack.push({type:"elif",obj:c,chain:f});this.funcs[l]=p(this.funcs[l],function(){return c.endI});return this};d.prototype.aElse=function(){var b=this.ifStack.pop(),c={},d=b.chain.concat([c]),f=this.getCurIndex();b.obj.elseI=f+1;this.funcs.push(q);this.ifStack.push({type:"else",
obj:c,chain:d});this.funcs[f]=p(this.funcs[f],function(){return c.endI});return this};d.prototype.endIf=function(b){b||this.funcs.push(n);b=this.ifStack.pop();var c=this.getCurIndex();b.obj.elseI=c+1;b.chain.forEach(function(b){b.endI=c+1});return this}})();
